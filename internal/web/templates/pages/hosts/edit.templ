package hosts

import "github.com/fr4nsys/usulnet/internal/web/templates/layouts"

type EditData struct {
	PageData    layouts.PageData
	Error       string
	Host        EditHost
	AgentToken  string // Shown only once after generation
}

type EditHost struct {
	ID           string
	Name         string
	DisplayName  string
	EndpointType string
	EndpointURL  string
	Status       string
	TLSEnabled   bool
}

templ Edit(data EditData) {
	@layouts.Base(data.PageData) {
		<div class="space-y-6">
			<!-- Breadcrumb -->
			<nav class="flex items-center gap-2 text-sm text-gray-400">
				<a href="/nodes" class="hover:text-primary-400 transition-colors">Nodes</a>
				<i class="fas fa-chevron-right text-xs"></i>
				<a href={ templ.SafeURL("/nodes/" + data.Host.ID) } class="hover:text-primary-400 transition-colors">{ data.Host.Name }</a>
				<i class="fas fa-chevron-right text-xs"></i>
				<span class="text-white">Edit</span>
			</nav>

			<div class="max-w-2xl">
				<div class="flex items-center gap-3 mb-6">
					<a href={ templ.SafeURL("/nodes/" + data.Host.ID) } class="text-gray-400 hover:text-white transition-colors">
						<i class="fas fa-arrow-left"></i>
					</a>
					<h2 class="text-xl font-display font-bold text-white">Edit Node</h2>
					@endpointBadge(data.Host.EndpointType)
				</div>

				if data.Error != "" {
					<div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4 mb-4">
						<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-1"></i>{ data.Error }</p>
					</div>
				}

				if data.AgentToken != "" {
					<div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 mb-6" x-data="{ token: $el.querySelector('[data-token]')?.textContent || '' }">
						<div class="flex items-start gap-3">
							<i class="fas fa-key text-green-400 mt-0.5"></i>
							<div class="flex-1">
								<p class="font-medium text-green-400 mb-2">Agent Token Generated</p>
								<p class="text-sm text-gray-300 mb-3">Copy this token now. It will not be shown again.</p>
								<div class="flex items-center gap-2">
									<code data-token class="flex-1 bg-dark-900 rounded px-3 py-2 text-sm font-mono text-white break-all select-all">{ data.AgentToken }</code>
									<button
										type="button"
										x-on:click="navigator.clipboard.writeText($el.previousElementSibling.textContent.trim())"
										class="px-3 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors flex-shrink-0"
										title="Copy to clipboard"
									>
										<i class="fas fa-copy"></i>
									</button>
								</div>
							</div>
						</div>
					</div>
				}

				<form method="POST" action={ templ.SafeURL("/nodes/" + data.Host.ID) } class="space-y-6" x-data={ "{ tlsEnabled: " + boolStr(data.Host.TLSEnabled) + " }" }>
					<input type="hidden" name="csrf_token" value={ data.PageData.CSRFToken }/>

					<!-- Display Name -->
					<div>
						<label class="block text-sm font-medium text-gray-300 mb-1">Display Name</label>
						<input
							type="text"
							name="display_name"
							value={ displayOrName(data.Host.DisplayName, data.Host.Name) }
							placeholder="Friendly name for this node"
							class="w-full bg-dark-800 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
						/>
					</div>

					<!-- Endpoint URL (TCP only) -->
					if data.Host.EndpointType == "tcp" {
						<div>
							<label class="block text-sm font-medium text-gray-300 mb-1">Endpoint URL</label>
							<input
								type="text"
								name="endpoint_url"
								value={ data.Host.EndpointURL }
								placeholder="tcp://192.168.1.100:2376"
								class="w-full bg-dark-800 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
							/>
						</div>

						<!-- TLS Configuration -->
						<div>
							<label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer mb-3">
								<input type="checkbox" name="tls_enabled" value="true" x-model="tlsEnabled" class="rounded border-dark-600 bg-dark-800 text-primary-500 focus:ring-primary-500"/>
								Enable TLS
							</label>
							<div x-show="tlsEnabled" x-transition class="space-y-4 pl-6 border-l-2 border-dark-600">
								<div>
									<label class="block text-sm font-medium text-gray-300 mb-1">CA Certificate</label>
									<textarea
										name="tls_ca_cert"
										rows="3"
										placeholder="Paste new certificate to replace (leave empty to keep current)"
										class="w-full bg-dark-800 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500 focus:border-transparent"
									></textarea>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-300 mb-1">Client Certificate</label>
									<textarea
										name="tls_client_cert"
										rows="3"
										placeholder="Paste new certificate to replace (leave empty to keep current)"
										class="w-full bg-dark-800 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500 focus:border-transparent"
									></textarea>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-300 mb-1">Client Key</label>
									<textarea
										name="tls_client_key"
										rows="3"
										placeholder="Paste new key to replace (leave empty to keep current)"
										class="w-full bg-dark-800 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500 focus:border-transparent"
									></textarea>
								</div>
							</div>
						</div>
					}

					<!-- Agent Token Management -->
					if data.Host.EndpointType == "agent" {
						<div class="card p-4">
							<div class="flex items-center justify-between">
								<div class="flex items-center gap-3">
									<i class="fas fa-key text-yellow-400"></i>
									<div>
										<p class="text-sm font-medium text-white">Agent Token</p>
										<p class="text-xs text-gray-500">Regenerate the token if the agent needs to reconnect</p>
									</div>
								</div>
								<button
									type="submit"
									name="action"
									value="regenerate_token"
									class="px-3 py-1.5 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 rounded-lg text-sm transition-colors"
								>
									<i class="fas fa-sync-alt mr-1"></i>Regenerate
								</button>
							</div>
						</div>
					}

					<!-- Submit -->
					<div class="flex items-center justify-between pt-2">
						<div class="flex gap-3">
							<button type="submit" name="action" value="save" class="btn btn-primary">
								<i class="fas fa-save mr-2"></i>Save Changes
							</button>
							<a href={ templ.SafeURL("/nodes/" + data.Host.ID) } class="btn btn-secondary">Cancel</a>
						</div>
						<button
							type="button"
							class="text-sm text-red-400 hover:text-red-300 transition-colors"
							hx-delete={ "/nodes/" + data.Host.ID }
							hx-confirm="Are you sure you want to delete this node? This action cannot be undone."
						>
							<i class="fas fa-trash-alt mr-1"></i>Delete Node
						</button>
					</div>
				</form>

				<!-- Deploy Agent Section (agent-type hosts only) -->
				if data.Host.EndpointType == "agent" {
					<div class="mt-8 pt-8 border-t border-dark-600">
						<div class="flex items-center gap-3 mb-4">
							<div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
								<i class="fas fa-rocket text-green-400"></i>
							</div>
							<div>
								<h3 class="text-lg font-semibold text-white">Deploy Agent</h3>
								<p class="text-sm text-gray-400">Install the usulnet agent on a remote host via SSH</p>
							</div>
						</div>
						<div x-data={ deployAgentData(data.Host.ID, data.AgentToken, data.PageData.CSRFToken) } class="space-y-4">
							<!-- Deploy form -->
							<div x-show="!deploying && !deployResult">
								<div class="bg-dark-800 rounded-xl border border-dark-600 p-5 space-y-4">
									<div class="bg-blue-500/5 border border-blue-500/20 rounded-lg p-3 mb-2">
										<p class="text-sm text-gray-300">
											<i class="fas fa-info-circle text-blue-400 mr-1"></i>
											Connect via SSH to install and configure the agent. The remote host must have Docker installed and the user needs root or sudo access.
										</p>
									</div>
									<!-- SSH Host -->
									<div>
										<label class="block text-sm font-medium text-gray-300 mb-1">Host / IP Address</label>
										<input
											type="text"
											x-model="sshHost"
											placeholder="192.168.1.100 or server.example.com"
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										/>
									</div>
									<!-- SSH User -->
									<div>
										<label class="block text-sm font-medium text-gray-300 mb-1">SSH User</label>
										<input
											type="text"
											x-model="sshUser"
											placeholder="root"
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										/>
										<p class="text-xs text-gray-500 mt-1">User must be root or have sudo privileges</p>
									</div>
									<!-- Auth Type -->
									<div>
										<label class="block text-sm font-medium text-gray-300 mb-1">Authentication</label>
										<select
											x-model="sshAuthType"
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										>
											<option value="password">Password</option>
											<option value="key">SSH Key</option>
										</select>
									</div>
									<!-- Password -->
									<div x-show="sshAuthType === 'password'" x-transition>
										<label class="block text-sm font-medium text-gray-300 mb-1">Password</label>
										<input
											type="password"
											x-model="sshPassword"
											placeholder="SSH password"
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										/>
									</div>
									<!-- Private Key -->
									<div x-show="sshAuthType === 'key'" x-transition>
										<label class="block text-sm font-medium text-gray-300 mb-1">Private Key</label>
										<textarea
											x-model="sshPrivateKey"
											rows="4"
											placeholder={ "-----BEGIN OPENSSH PRIVATE KEY-----\n..." }
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										></textarea>
									</div>
									<!-- Gateway URL -->
									<div>
										<label class="block text-sm font-medium text-gray-300 mb-1">Gateway URL (NATS)</label>
										<input
											type="text"
											x-model="gatewayURL"
											placeholder="nats://master-ip:4222"
											class="w-full bg-dark-900 border border-dark-600 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
										/>
										<p class="text-xs text-gray-500 mt-1">NATS URL the agent will use to connect back to this master</p>
									</div>
									<!-- Error message -->
									<template x-if="error">
										<div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3">
											<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-1"></i><span x-text="error"></span></p>
										</div>
									</template>
									<!-- Deploy button -->
									<button
										type="button"
										x-on:click="startDeploy()"
										class="btn btn-primary w-full"
										x-bind:disabled="!sshHost || !sshUser || (sshAuthType === 'password' && !sshPassword) || !gatewayURL"
									>
										<i class="fas fa-rocket mr-2"></i>Deploy Agent
									</button>
								</div>
							</div>
							<!-- Deploy progress -->
							<template x-if="deploying || deployResult">
								<div class="bg-dark-800 rounded-xl border border-dark-600 p-5 space-y-4">
									<div class="flex items-center gap-3">
										<template x-if="deployResult && deployResult.status === 'complete'">
											<div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
												<i class="fas fa-check text-green-400"></i>
											</div>
										</template>
										<template x-if="deployResult && deployResult.status === 'failed'">
											<div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center">
												<i class="fas fa-times text-red-400"></i>
											</div>
										</template>
										<template x-if="!deployResult || (deployResult.status !== 'complete' && deployResult.status !== 'failed')">
											<div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center">
												<i class="fas fa-spinner fa-spin text-blue-400"></i>
											</div>
										</template>
										<div>
											<p class="text-white font-medium" x-text="deployResult ? (deployResult.status === 'complete' ? 'Deployment Complete' : deployResult.status === 'failed' ? 'Deployment Failed' : 'Deploying...') : 'Starting deployment...'"></p>
											<p class="text-xs text-gray-400" x-show="deployResult && deployResult.step" x-text="deployResult ? deployResult.step : ''"></p>
										</div>
									</div>
									<!-- Deploy logs -->
									<div class="bg-dark-900 rounded-lg p-3 max-h-64 overflow-y-auto font-mono text-xs" x-ref="deployLogs">
										<template x-if="deployResult && deployResult.logs">
											<template x-for="(log, idx) in deployResult.logs" :key="idx">
												<div class="text-gray-300 py-0.5" x-text="log"></div>
											</template>
										</template>
									</div>
									<!-- Error -->
									<template x-if="deployResult && deployResult.error">
										<div class="text-red-400 text-sm font-medium" x-text="'Error: ' + deployResult.error"></div>
									</template>
									<!-- Actions after completion -->
									<template x-if="deployResult && (deployResult.status === 'complete' || deployResult.status === 'failed')">
										<div class="flex gap-3">
											<template x-if="deployResult.status === 'complete'">
												<a x-bind:href="'/nodes/' + hostID" class="btn btn-primary">
													<i class="fas fa-arrow-right mr-2"></i>View Node
												</a>
											</template>
											<button type="button" x-on:click="resetDeploy()" class="btn btn-secondary">
												<i class="fas fa-redo mr-2"></i>Deploy Again
											</button>
										</div>
									</template>
								</div>
							</template>
						</div>
					</div>
				}
			</div>
		</div>
	}
}

// deployAgentData generates the Alpine.js x-data for the deploy form.
func deployAgentData(hostID, agentToken, csrfToken string) string {
	return `{
		hostID: '` + hostID + `',
		agentToken: '` + agentToken + `',
		csrfToken: '` + csrfToken + `',
		sshHost: '',
		sshUser: 'root',
		sshAuthType: 'password',
		sshPassword: '',
		sshPrivateKey: '',
		gatewayURL: '',
		error: '',
		deploying: false,
		deployID: '',
		deployResult: null,
		pollInterval: null,
		async startDeploy() {
			this.error = '';
			this.deploying = true;
			try {
				const form = new FormData();
				form.append('csrf_token', this.csrfToken);
				form.append('ssh_host', this.sshHost);
				form.append('ssh_user', this.sshUser);
				form.append('ssh_auth_type', this.sshAuthType);
				form.append('ssh_password', this.sshPassword);
				form.append('agent_token', this.agentToken);
				form.append('gateway_url', this.gatewayURL);
				if (this.sshAuthType === 'key') {
					form.append('ssh_private_key', this.sshPrivateKey);
				}
				const resp = await fetch('/nodes/' + this.hostID + '/deploy', {
					method: 'POST',
					body: form
				});
				if (resp.redirected) {
					const url = new URL(resp.url);
					const parts = url.pathname.split('/');
					this.deployID = parts[parts.length - 1];
				} else if (resp.headers.get('HX-Redirect')) {
					const redir = resp.headers.get('HX-Redirect');
					const parts = redir.split('/');
					this.deployID = parts[parts.length - 1];
				} else if (!resp.ok) {
					const text = await resp.text();
					this.error = text || 'Deployment failed';
					this.deploying = false;
					return;
				}
				this.startPolling();
			} catch(e) {
				this.error = e.message || 'Network error';
				this.deploying = false;
			}
		},
		startPolling() {
			if (this.pollInterval) clearInterval(this.pollInterval);
			this.pollInterval = setInterval(async () => {
				try {
					const resp = await fetch('/nodes/' + this.hostID + '/deploy/' + this.deployID + '?format=json');
					if (resp.ok) {
						this.deployResult = await resp.json();
						if (this.$refs.deployLogs) {
							this.$refs.deployLogs.scrollTop = this.$refs.deployLogs.scrollHeight;
						}
						if (this.deployResult.status === 'complete' || this.deployResult.status === 'failed') {
							clearInterval(this.pollInterval);
							this.pollInterval = null;
							this.deploying = false;
						}
					}
				} catch(e) {}
			}, 2000);
		},
		resetDeploy() {
			this.deploying = false;
			this.deployResult = null;
			this.deployID = '';
			this.error = '';
			if (this.pollInterval) {
				clearInterval(this.pollInterval);
				this.pollInterval = null;
			}
		}
	}`
}

templ endpointBadge(t string) {
	switch t {
		case "local":
			<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-primary-500/20 text-primary-400">
				<i class="fas fa-home mr-1"></i>Local
			</span>
		case "tcp":
			<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
				<i class="fas fa-network-wired mr-1"></i>TCP
			</span>
		case "agent":
			<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400">
				<i class="fas fa-satellite-dish mr-1"></i>Agent
			</span>
		default:
			<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-dark-600 text-gray-400">
				{ t }
			</span>
	}
}

func displayOrName(display, name string) string {
	if display != "" {
		return display
	}
	return name
}
